# ValutaTrade Hub

ValutaTrade Hub - это платформа для отслеживания и симуляции торговли валютами, которая позволяет пользователям учитывать сделки купли/продажи в своём портфеле фиатных и криптовалют. Для каждой валюты используется отдельный кошелёк. Также доступна возможность запрашивать актуальные курсы валют от сервисов CoinGecko и ExchangeRateApi.

## Демонстрация работы

Регистрация, покупка и продажа, вывод информации о портфеле и курсе обмена валютной пары:

[![asciicast](https://asciinema.org/a/dGJFxVlYzHTv03w1DNHjxIxGa.svg)](https://asciinema.org/a/dGJFxVlYzHTv03w1DNHjxIxGa)

Обновление и вывод информации о курсах обмена валют, используя сторонние сервисы:

[![asciicast](https://asciinema.org/a/7MvR8rARJer4C8paSxzB7z6ax.svg)](https://asciinema.org/a/7MvR8rARJer4C8paSxzB7z6ax)

Обработка ошибок при работе:

[![asciicast](https://asciinema.org/a/AB0sfXaGEwmKZJveGfpRqAiYa.svg)](https://asciinema.org/a/AB0sfXaGEwmKZJveGfpRqAiYa)

## Установка

Для работы программы потребуется [Python3](https://www.python.org/) и [Poetry](https://python-poetry.org/). Для установки платформы нужно выполнить следующую команду из директории с проектом:

```shell
poetry install
```

## Настройка перед запуском

Настройки хранятся в файле конфигурации `pyproject.toml` в секции `[tool.valutatrade]`:
- `data_path` - путь к директории, где будут храниться данные
- `log_path` - путь к директории, где будут храниться логи
- `base_currency` - базовая валюта, в которой будут происходить все расчёты
- `rates_ttl_seconds` - время в секундах, по истечении которого курс обмена считается устаревшим
- `auto_update_rates` - автоматически обновлять курс обмена валют, если они устарели
- `show_dated_rates` - допустить вывод устаревших курсов обмена валют

Значения по умолчанию:

```
[tool.valutatrade]
data_path = "data/"
log_path = "logs/"
base_currency = "USD"
rates_ttl_seconds = 300
auto_update_rates = true
show_dated_rates = false
```

Для работы с сервисом **ExchangeRate-API** можно задать ключ для получения более свежих курсов обмена валют (без ключа данные обновляются раз в 24 часа). Для этого нужно добавить переменную окружения `EXCHANGERATE_API_KEY`, которая считывается программой во время работы:

```shell
export EXCHANGERATE_API_KEY="<Ваш ключ ExchangeRate-API>"
```

## Работа с платформой

Для запуска выполняем:

```shell
poetry run project
```

или

```shell
make project
```

Список доступных команд появится на экране сразу после запуска.

Справку о какой-то конкретной команде можно получить с помощью команды `help`:

```shell
help <команда>
```

### Регистрация

Некоторые команды требуют авторизацию, поэтому сначала необходимо зарегистрировать нового пользователя.
Предположим, что имя нового пользователя `alice`, а пароль `1234`:

```shell
register --username alice --password 1234
```

Авторизуемся:

```shell
login --username alice --password 1234
```

### Покупка/продажа

Для покупки и продажи валют используются команды `buy` и `sell`. Покупка устроена следующим образом: сумма транзакции списывается с кошелька с базовой валютой и добавляется на кошелёк с валютой покупки. Продажа сделана аналогично.

> Для пополнения или снятия средств с кошелька с базовой валютой нужно указать её в качестве валюты покупки или продажи.

Пополняем кошелёк:

```shell
buy --currency USD --amount 100000
```

Произведём покупку валют:

```shell
buy --currency BTC --amount 0.5
buy --currency ETH --amount 10
buy --currency JPY --amount 250000
```

Для отображения состояния портфеля можно пользоваться командой `show-portfolio`, которая покажет такую информацию:

```
> show-portfolio
Портфель пользователя 'alice' (база: USD):
- USD:  13532.30 -> 13532.30 USD
- BTC:      0.50 -> 50952.50 USD
- ETH:     10.00 -> 33728.60 USD
- JPY: 250000.00 ->  1631.50 USD
-----------------------------------
ИТОГО: 99844.90 USD
```

Через некоторое время произведём продажу:

```shell
sell --currency ETH --amount 2
```

И снова отобразим состояние портфеля:

```
> show-portfolio
Портфель пользователя 'alice' (база: USD):
- USD:  20336.78 -> 20336.78 USD
- BTC:      0.50 -> 51269.00 USD
- ETH:      8.00 -> 27217.92 USD
- JPY: 250000.00 ->  1631.50 USD
-----------------------------------
ИТОГО: 100455.20 USD
```

Из-за волатильности курсов обмена, портфель может измениться в цене при пересчёте в базовую валюту.

### Курсы обмена валют

Для отображения курсов всех валют, которые доступны в системе, используется команда `show-rates`:

- `show-rates` - курсы всех валют (сортировка по алфавиту)
- `show-rates --currency BTC` - курс обмена указанной валюты
- `show-rates --top 3` - указанное количество самых дорогих валют

> Если курсы устарели, то их обновление может быть выполнено автоматически (см. раздел "Настройка перед запуском").

Можно добавлять опциональный параметр `--base`, чтобы использовать указанную валюту в качестве базовой для отображения курсов. Например, вывести 5 самых дорогих валют с переводом в рубли:

```shell
show-rates --top 5 --base RUB
```

Результат:

```
Курсы обмена валют из кэша (обновлялся 2025-11-07 20:50:14)
- BTC->RUB: 8249064.000000
- ETH->RUB:  273029.000000
- BNB->RUB:   78034.000000
- SOL->RUB:   12997.540000
- XRP->RUB:     186.980000
```

Для обновления по требованию можно воспользоваться командой `update-rates`. Для указания конкретного сервиса, с которого требуется загрузить данные, добавляется параметр `--source`:
- `update-rates` - все сервисы
- `update-rates --source coingecko` - [CoinGecko](https://www.coingecko.com/)
- `update-rates --source exchangerate` - [ExchangeRate-API](https://www.exchangerate-api.com/)

Для просмотра курса обмена валют для конкретной валютной пары применяем команду `get-rate`:

```shell
get-rate --from XRP --to USD
```

Будет показан прямой и обратный курсы обмена:

```
Курс XRP->USD: 2.310000 (обновлено: 2025-11-07 20:50:14)
Обратный курс USD->XRP: 0.432900
```

## Структура проекта

Пакет `valutatrade_hub` состоит из нескольких частей:
- `cli` - содержит интерфейс командной строки, с которым взаимодействует пользователь.
- `core` - модели, исключения, бизнес-логика и вспомогательный код
- `infra` - код для сохранения данных в JSON-файлы и чтения конфигурации
- `parser_service` - сервис для запроса обновлённых курсов валют с помощью сторонних API и сохранения результатов.
- отдельные модули для ведения логов (декоратор @log_action и конфигурация)

Директория с данными, указанная по ключу `data_path` конфигурации, содержит несколько файлов формата JSON:
- `users.json` - информация о зарегистрированных пользователях
- `portfolios.json` - информация о портфелях и кошельках пользователей
- `rates.json` - срез последних (оперативных) курсов обмена валют
- `exchange_rates.json` - история курсов обмена валют

Директория с файлами логов содержит (ключ `log_path`):
- `actions.log` - аудит действий пользователей по покупке и продаже валют
- `parser.log` - журнал взаимодействия со сторонними сервисами для обновления курсов обмена
